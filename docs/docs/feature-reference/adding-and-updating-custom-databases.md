# Adding and Updating Custom Databases

You can add or update custom reference databases using Toolchest – the interface is the same as running any tool, 
except `inputs` is replaced by `database_path`.

Adding and updating databases function as [Async Runs](async-runs.md). The `add_database` and 
`update_database` functions return after transferring the data with:

- a unique ID that you can use with `.get_status()` to track status
- the new `database_name` and `database_version`

##  Adding a Custom Database

You can add a custom database for any tool that exists in Toolchest. 

The custom database must already be generated for the specific tool. For example, the custom database for Kraken 2 must 
be generated by `kraken2-build` rather than a collection of FASTQ files.

Arguments:

- `database_path`:  Path or list of paths (local or S3) to file(s) containing the custom database. This can be a prefix
  (i.e., a local directory or an S3 "directory"-style prefix).
- `tool`: Toolchest tool class with which you use the database (e.g. `toolchest.tools.DiamondBlastp`, 
`toolchest.tools.Kraken2`).
- `database_name`: Name of the new custom database.
- `database_primary_name`: If you are uploading multiple database files and your tool takes in a certain file or prefix 
instead of the whole directory as its command-line argument, use this to specify the name of that file or prefix.
See the "[Specifying `database_primary_name`](adding-and-updating-custom-databases.md#specifying-database_primary_name)" 
section for more details.

The return is a `Toolchest.api.Output` object, containing:

- `database_name`
- `database_version`
- `run_id`

Here's an example of adding a custom database for Kraken 2 using an S3 prefix URI.

```python
import toolchest_client as tc

tc.set_key("YOUR_KEY")

tc.update_database(
  # arbitrary-directory is a prefix containing files like arbitrary-directory/db.files.1
  database_path="s3://example-s3-bucket/arbitrary-directory/",
  tool=tc.tools.Kraken2,
  database_name="example-db-name",
  database_primary_name="db.files",
)
```

Note that it may take up to 1 hour for the custom database to be ready to use.

##  Updating a Custom Database

You can create a new custom version for any tool and database in Toolchest. This is very similar to adding a custom 
database, except the `database_name` for the database must already exist.

Arguments:

- `database_path`:  Path or list of paths (local or S3) to file(s) containing the custom database. This can be a prefix
  (i.e., a local directory or an S3 "directory"-style prefix).
- `tool`: Toolchest tool class with which you use the database (e.g. `toolchest.tools.DiamondBlastp`, 
`toolchest.tools.Kraken2`).
- `database_name`: Name of the _existing_ database.
- `database_primary_name`: If you are uploading multiple database files and your tool takes in a certain file or prefix 
instead of the whole directory as its command-line argument, use this to specify the name of that file or prefix.
See the "[Specifying `database_primary_name`](adding-and-updating-custom-databases.md#specifying-database_primary_name)" 
section for more details.

  **NOTE**: This argument is **optional** for `update_database`. If omitted, it assumes the same `database_primary_name` as the previous
version of the custom database.

Returns a Toolchest.api.Output object, containing:

- `database_name`
- `database_version` (auto-incremented from the latest version)
- `run_id`

Here's an example update of the standard Kraken 2 database:

```python
import toolchest_client as tc

tc.set_key("YOUR_KEY")

tc.update_database(
  database_path=[
    "s3://toolchest-integration-tests/arbitrary_directory/db.files.1",
    "s3://toolchest-integration-tests/arbitrary_directory/db.files.2",
  ],
  tool=tc.tools.Kraken2,
  database_name="standard",
  database_primary_name="db.files",
)
```

Note that it may take up to 1 hour for the custom database to be ready to use.

## Preserving File Structure
**Use a prefix** as your `database_path` if you have a custom database that requires preserving directory structure. For 
both local and S3 paths, this will place all files in their implied subdirectories.

If a list of paths is used instead, file structure will **not be preserved**. All specified files will be placed into 
the same directory.

## Specifying `database_primary_name`
If you are uploading multiple database files and your tool takes in a certain file or prefix 
**instead of the whole directory** as its command-line argument, use `database_primary_name` to specify the name of 
that file or prefix.

For example, if your database is structured like:
```text
arbitrary-directory/
├── db.files.1
├── db.files.2
└── db.files.3
```
and you would use this command to run the tool from the command line:
```commandline
example_tool --database arbitrary-directory/db.files --input example_input.fastq --output example_output_dir/
```
then you would specify `database_primary_name=db.files`, the **base name** of the database argument, in your 
Toolchest call.

### Specifying the directory itself
Use `database_primary_name=None` for `add_database` if there is no primary name (i.e., the directory itself is the 
command-line database).

### Behavior differences
Note that the argument's behavior is **slightly different** for `add_database` and `update_database`:
- This argument is **mandatory** for `add_database`.
- This argument is **optional** for `update_database`. If omitted, it assumes the same `database_primary_name` as the previous
version of the custom database.
  - If `database_primary_name` needs to be changed to `None`, contact Toolchest to correct this. 


## Security

By default, the privacy setting of all custom databases is the equivalent of "unlisted". This means that if anybody 
else knows the name and version of your database, they can access it.

We support fully private custom databases as a part of the managed-hosted and on-prem versions of Toolchest.